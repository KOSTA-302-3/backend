name: Notify Slack on PR Events

on:
  pull_request:
    types: [opened, closed, review_requested]
    branches:
      - '**'

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Send Slack Notification with Mentions
        run: |
          # PR 정보 가져오기
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_ACTION="${{ github.event.action }}"
          PR_IS_DRAFT=${{ github.event.pull_request.draft }}
    
          # Draft PR일 경우 알림 스킵
          if [ "$PR_ACTION" == "opened" ] && [ "$PR_IS_DRAFT" == "true" ]; then
            echo "Draft PR입니다. Slack 알림을 생략합니다."
            exit 0
          fi
    
          # PR 작성자 / 리뷰 요청자
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          REQUESTED_REVIEWER="${{ github.event.requested_reviewer.login }}"
    
          # Secret에서 JSON 로드
          USER_MAP_JSON=${{ secrets.USER_MAP }}
    
          # GitHub ID → Slack ID 변환 함수
          get_slack_id() {
            local github_id="$1"
            
            if [ -z "$github_id" ]; then
              echo "unknown"
              return
            fi
            
            # jq로 JSON에서 Slack ID 추출
            local slack_id
            slack_id=$(echo "$USER_MAP_JSON" | jq -r --arg user "$github_id" '.[$user] // "unknown"')
            echo "$slack_id"
          }
    
          # 변환된 Slack ID 얻기
          SLACK_AUTHOR_ID=$(get_slack_id "$PR_AUTHOR")
          SLACK_REVIEWER_ID=$(get_slack_id "$REQUESTED_REVIEWER")
    
          # PR 상태별 메시지 생성
          if [ "$PR_ACTION" == "opened" ]; then
            PR_STATUS="*새 PR이 생성되었습니다!*"
    
            ALL_MENTIONS=""
            # JSON key 목록을 순회하며 전체 멘션 생성
            for github_user in $(echo "$USER_MAP_JSON" | jq -r 'keys[]'); do
              slack_id=$(get_slack_id "$github_user")
              ALL_MENTIONS+="<@$slack_id> "
            done
    
          elif [ "$PR_ACTION" == "ready_for_review" ]; then
            PR_STATUS="*리뷰 준비 완료!*"
    
            ALL_MENTIONS=""
            for github_user in $(echo "$USER_MAP_JSON" | jq -r 'keys[]'); do
              slack_id=$(get_slack_id "$github_user")
              ALL_MENTIONS+="<@$slack_id> "
            done
    
          elif [ "$PR_ACTION" == "review_requested" ]; then
            PR_STATUS="*리뷰 재요청 발생!*"
            ALL_MENTIONS="<@$SLACK_REVIEWER_ID>"
    
          elif [ "$PR_ACTION" == "closed" ]; then
            if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
              PR_STATUS="*PR Merged*"
              ALL_MENTIONS=""
            else
              PR_STATUS="*PR Closed (미머지)*"
              ALL_MENTIONS=""
            fi
    
          elif [ "$PR_ACTION" == "reopened" ]; then
            PR_STATUS="*PR이 다시 열렸습니다!*"
    
            ALL_MENTIONS=""
            for github_user in $(echo "$USER_MAP_JSON" | jq -r 'keys[]'); do
              slack_id=$(get_slack_id "$github_user")
              ALL_MENTIONS+="<@$slack_id> "
            done
    
          else
            PR_STATUS="*PR 업데이트*"
            ALL_MENTIONS=""
          fi
    
          # Slack 웹훅 호출
          curl -X POST \
               -H 'Content-type: application/json' \
               --data "{
                 \"text\": \"${PR_STATUS}\n*PR 제목:* ${PR_TITLE} (#${PR_NUMBER})\n*작성자:* <@${SLACK_AUTHOR_ID}>\n*리뷰어:* ${ALL_MENTIONS}\n*링크:* ${PR_URL}\"
               }" \
               ${{ secrets.SLACK_WEBHOOK_URL }}
